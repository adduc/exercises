---
services:
  server:
    image: local/ansible-alpine:3.21-amd64
    working_dir: /etc/ansible
    volumes:
      - ./:/etc/ansible

      # Mount the user's SSH keys to use when running Ansible playbooks.
      - ~/.ssh:/home/ansible/.ssh:ro

    environment:
      USER_ANSIBLE: ansible
      ANSIBLE_USER_ID: 1000

  target:
    image: local/ansible-target-ubuntu:24.04-amd64

    # To replicate a typical Ubuntu server environment, we will use
    # systemd as the init system. Unlike other init systems, systemd
    # requires a few additional configurations to work properly in
    # a container.
    cgroup: host
    tmpfs: [/run]
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw

      # If SSH keys are mounted, the entry point script will
      # automatically trust them to allow Ansible to connect
      # to the target container.
      - ~/.ssh:/mnt/user-ssh:ro

      # Mount the system's SSH configuration to use the SSH keys instead
      # of generating new ones each time the container starts.
      - /etc/ssh:/etc/ssh:ro

    # This is optional, but it allows you to see the output of systemd
    # in the container logs, which can be useful for debugging.
    tty: true
